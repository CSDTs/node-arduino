<!DOCTYPE html>
<html>
    <head>
    	<meta charset = "utf-8"/>
        <title>Websocket test page</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    </head>
    <body>
    	<canvas id="myChart" style="width:600px;height:250px;"></canvas>

    	<script>	
    		var socket = new WebSocket("ws://127.0.0.1:8080");
    		var val =  document.getElementById('val');
    		socket.onmessage = function(event) {
    			// console.log(event.data);
    			if(hasHeader(event.data)) {

    				var data = getHeaderAndData(event.data);
    				// console.log(data.header);

    				if(datasetExists(data.header)) {
    					addData(data.header, "", data.data);
    				} else {
    					addDataset(data.header, data.data);
    				}

    			} else {
    				addData("", "", event.data);
    			}
    		}

			var ctx = document.getElementById('myChart').getContext('2d');
			var chart = new Chart(ctx, {
			    type: 'line',
			    data: {
			        labels: [],
			        datasets: []
			    },

			    options: {
			    	scales: {
			    		xAxes: [{
			    			gridLines: {
			    				display: false,
			    			}
			    		}]
			    	}
			    }
			});


			//clean up this function if possible TODO
			function addData(dataset_, label_, data_) {
				chart.data.labels.push(label_); //this line is weirdly necessary research why TODO
				chart.data.datasets.forEach( (dataset) => {
					console.log(dataset.label);
					if (dataset.label == dataset_) {
						dataset.data.push(data_);
					}
				});
				chart.update();
			}

			function hasHeader(data) {
				for(var i = 0; i < data.length; i++) { //assuming there's only one piece of data per line!
					if(data[i] == ':') {
						return true;
					}
				}
				return false;
			}

			//look into making this more general and easier on the users (i.e can handle any formatting) TODO
			function getHeaderAndData(data) {
				var i = 0;
				while (data[i] !== ":") {
					i++;
				}
				var header_ = data.substr(0, i)
				var data_ = data.substr(i+2, data.length - 1); //i+2 assumes the message is "header: value" (accounts for space)
				var header_and_data = {
					data: data_,
					header: header_
				}
				return header_and_data;
			}

			function datasetExists(header) {
				var exists = false;
				for (var i = 0; i < chart.data.datasets.length; i++) {
					if (chart.data.datasets[i].label == header) {
						exists = true;
					}
				}
				return exists;
			}

			function addDataset(header, data) {
				var new_dataset = {
					label: header, 
					data: [0, data],
					borderColor: "blue",
					fill: false
				}
				chart.data.datasets.push(new_dataset);
				chart.update();
			}

		</script>
    </body>
</html>